<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ä½ ç¦»è‡ªç”±è¿˜æœ‰å¤šè¿œï¼Ÿ| åŒ—äº¬æå‰é€€ä¼‘è®¡ç®—å™¨</title>
<!-- Fluent UI Web Components -->
<script type="module" src="https://unpkg.com/@fluentui/web-components"></script>
<style>
  :root {
    --colorNeutralBackground1: #f5f5f5;
    --colorNeutralBackground2: #ffffff;
    --colorNeutralBackground3: #f0f0f0;
    --colorBrandPrimary: #4A5FDB;
    --colorBrandHover: #3D4FB8;
    --colorBrandSubtle: #E8EBFA;
    --colorBrandBackground: #0078d4;
    --colorBrandBackgroundHover: #106ebe;
    --colorNeutralForeground1: #242424;
    --colorNeutralForeground2: #616161;
    --colorNeutralForeground3: #9e9e9e;
    --colorStatusSuccessBackground1: #dff6dd;
    --colorStatusSuccessForeground1: #107c10;
    --colorStatusDangerBackground1: #fde7e9;
    --colorStatusDangerForeground1: #c50f1f;
    --colorNeutralStroke1: #e0e0e0;
    --colorNeutralStroke2: #d1d1d1;
    --shadow2: 0 1px 2px rgba(0,0,0,0.06);
    --shadow4: 0 2px 4px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06);
    --shadow8: 0 4px 8px rgba(0,0,0,0.06), 0 2px 4px rgba(0,0,0,0.04);
    --shadow16: 0 8px 16px rgba(0,0,0,0.08), 0 4px 8px rgba(0,0,0,0.04);
    --borderRadius: 12px;
    --borderRadiusLarge: 16px;
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: "Segoe UI", "Segoe UI Web", -apple-system, BlinkMacSystemFont, Roboto, "Helvetica Neue", sans-serif;
    background: linear-gradient(180deg, var(--colorBrandSubtle) 0%, var(--colorNeutralBackground1) 300px);
    color: var(--colorNeutralForeground1);
    line-height: 1.5;
    min-height: 100vh;
  }

  .container {
    max-width: 640px;
    margin: 0 auto;
    padding: 32px 20px;
  }

  .card {
    background: var(--colorNeutralBackground2);
    border-radius: var(--borderRadiusLarge);
    padding: 28px;
    margin: 20px 0;
    box-shadow: var(--shadow8);
    border: 1px solid var(--colorNeutralStroke1);
    transition: box-shadow 0.3s, transform 0.3s;
  }

  .card:hover {
    box-shadow: var(--shadow16);
  }

  h1 {
    font-size: 32px;
    font-weight: 700;
    margin: 0 0 8px;
    color: var(--colorNeutralForeground1);
    letter-spacing: -0.5px;
  }

  h2 {
    font-size: 20px;
    font-weight: 600;
    margin: 0 0 20px;
    color: var(--colorNeutralForeground1);
  }

  p {
    color: var(--colorNeutralForeground2);
    margin: 8px 0;
  }

  .subtitle {
    font-size: 15px;
    color: var(--colorNeutralForeground2);
    margin-bottom: 24px;
  }

  .form-field {
    margin-bottom: 24px;
  }

  .form-field label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--colorNeutralForeground1);
  }

  .hint {
    font-size: 12px;
    color: var(--colorNeutralForeground2);
    margin-top: 6px;
    line-height: 1.5;
  }

  fluent-text-field, fluent-select, fluent-number-field {
    width: 100%;
  }

  fluent-text-field::part(root), 
  fluent-select::part(control),
  fluent-number-field::part(root) {
    border-radius: var(--borderRadius);
  }

  /* éªŒè¯é”™è¯¯æ ·å¼ */
  .field-invalid {
    --neutral-fill-input-rest: #fde7e9 !important;
  }
  .field-invalid::part(root),
  .field-invalid::part(control) {
    border: 2px solid #c50f1f !important;
    background: #fde7e9 !important;
  }

  /* Hero Card */
  .hero-card {
    text-align: center;
    padding: 48px 32px;
    background: linear-gradient(135deg, #ffffff 0%, var(--colorBrandSubtle) 100%);
    border: none;
  }

  .hero-icon {
    font-size: 64px;
    margin-bottom: 16px;
  }

  .primary-btn {
    background: var(--colorBrandPrimary);
    color: white;
    border: none;
    padding: 14px 40px;
    font-size: 16px;
    font-weight: 600;
    border-radius: var(--borderRadius);
    cursor: pointer;
    transition: all 0.25s;
    box-shadow: 0 4px 12px rgba(74, 95, 219, 0.3);
    font-family: inherit;
  }

  .primary-btn:hover {
    background: var(--colorBrandHover);
    box-shadow: 0 6px 20px rgba(74, 95, 219, 0.4);
    transform: translateY(-2px);
  }

  .primary-btn:active {
    transform: translateY(0);
  }

  .secondary-btn {
    background: transparent;
    color: var(--colorNeutralForeground1);
    border: 1px solid var(--colorNeutralStroke2);
    padding: 14px 24px;
    font-size: 16px;
    font-weight: 600;
    border-radius: var(--borderRadius);
    cursor: pointer;
    transition: all 0.25s;
    font-family: inherit;
  }

  .secondary-btn:hover {
    background: var(--colorNeutralBackground3);
    border-color: var(--colorNeutralStroke1);
  }

  .hero-card h1 {
    font-size: 36px;
    background: linear-gradient(135deg, var(--colorNeutralForeground1) 0%, var(--colorBrandPrimary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .hero-desc {
    font-size: 15px;
    color: var(--colorNeutralForeground2);
    max-width: 400px;
    margin: 0 auto;
    line-height: 1.6;
  }

  .hero-features {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-top: 24px;
    flex-wrap: wrap;
  }

  .feature-tag {
    font-size: 12px;
    color: var(--colorNeutralForeground2);
    background: rgba(255,255,255,0.8);
    padding: 6px 12px;
    border-radius: 20px;
    border: 1px solid var(--colorNeutralStroke1);
  }

  .btn-group {
    display: flex;
    gap: 12px;
    margin-top: 28px;
  }

  .btn-group button {
    flex: 1;
  }

  /* Progress Steps */
  .progress-steps {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0;
    margin-bottom: 32px;
  }

  .step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
  }

  .step-indicator {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--colorNeutralStroke1);
    color: var(--colorNeutralForeground2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .step-indicator.active {
    background: var(--colorBrandBackground);
    color: white;
  }

  .step-indicator.done {
    background: var(--colorStatusSuccessForeground1);
    color: white;
  }

  .step-label {
    font-size: 12px;
    color: var(--colorNeutralForeground2);
    margin-top: 6px;
    text-align: center;
  }

  .step-label.active {
    color: var(--colorBrandBackground);
    font-weight: 600;
  }

  .step-connector {
    width: 60px;
    height: 2px;
    background: var(--colorNeutralStroke1);
    margin: 0 8px;
    margin-bottom: 22px;
  }

  .step-connector.done {
    background: var(--colorStatusSuccessForeground1);
  }

  .hidden {
    display: none !important;
  }

  /* Result styles */
  .stat-card {
    background: var(--colorNeutralBackground2);
    border-radius: var(--borderRadiusLarge);
    padding: 24px;
    margin: 16px 0;
    box-shadow: var(--shadow8);
    border: 1px solid var(--colorNeutralStroke1);
    transition: box-shadow 0.3s, transform 0.3s;
  }

  .stat-card:hover {
    box-shadow: var(--shadow16);
    transform: translateY(-2px);
  }

  .stat-value {
    font-size: 36px;
    font-weight: 700;
    margin: 8px 0;
    letter-spacing: -0.5px;
  }

  .stat-value.positive {
    color: var(--colorStatusSuccessForeground1);
  }

  .stat-value.negative {
    color: #e85d04;
  }

  .data-table {
    width: 100%;
    border-collapse: collapse;
  }

  .data-table tr {
    border-bottom: 1px solid var(--colorNeutralStroke1);
  }

  .data-table tr:last-child {
    border-bottom: none;
  }

  .data-table th, .data-table td {
    padding: 12px 16px;
    font-size: 14px;
    text-align: right;
  }

  .data-table th:first-child, .data-table td:first-child {
    text-align: left;
    padding-left: 0;
  }

  .data-table th:last-child, .data-table td:last-child {
    padding-right: 0;
  }

  .data-table th {
    color: var(--colorNeutralForeground2);
    font-weight: 500;
  }

  .data-table td {
    color: var(--colorNeutralForeground1);
    font-weight: 500;
  }

  /* è“è‰²èƒŒæ™¯è¡Œ - ç™½è‰²æ–‡å­— */
  .data-table tr.highlight {
    background: var(--colorBrandPrimary);
  }

  .data-table tr.highlight td {
    color: white !important;
  }

  .badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 13px;
    font-weight: 500;
  }

  .badge.success {
    background: var(--colorStatusSuccessBackground1);
    color: var(--colorStatusSuccessForeground1);
  }

  .badge.danger {
    background: var(--colorStatusDangerBackground1);
    color: var(--colorStatusDangerForeground1);
  }

  .summary-list {
    padding-left: 20px;
    margin: 12px 0;
  }

  .summary-list li {
    margin: 8px 0;
    color: var(--colorNeutralForeground2);
  }

  .footer {
    text-align: center;
    padding: 20px;
    color: var(--colorNeutralForeground2);
    font-size: 12px;
  }

  .date-picker-row {
    display: flex;
    gap: 12px;
  }

  .date-picker-row fluent-select {
    flex: 1;
  }

  /* é™åˆ¶ä¸‹æ‹‰åˆ—è¡¨é«˜åº¦ */
  fluent-select::part(listbox) {
    max-height: 280px;
    overflow-y: auto;
  }

  /* å¯¹æ¯”è¡¨æ ¼é«˜äº®è¡Œ */
  .data-table tr.highlight {
    border-radius: 8px;
  }
  
  .data-table tr.highlight td {
    border-color: transparent;
  }

  /* Tab æ ·å¼ */
  .strategy-tabs {
    display: flex;
    gap: 8px;
    background: var(--colorNeutralBackground3);
    padding: 4px;
    border-radius: var(--borderRadius);
    margin-bottom: 24px;
  }
  
  .strategy-tab {
    flex: 1;
    padding: 12px 16px;
    font-size: 14px;
    font-weight: 600;
    color: var(--colorNeutralForeground2);
    background: transparent;
    border: none;
    border-radius: calc(var(--borderRadius) - 2px);
    cursor: pointer;
    transition: all 0.25s;
  }
  
  .strategy-tab:hover {
    color: var(--colorNeutralForeground1);
    background: rgba(255,255,255,0.5);
  }
  
  .strategy-tab.active {
    color: var(--colorBrandPrimary);
    background: var(--colorNeutralBackground2);
    box-shadow: var(--shadow4);
  }
  
  .strategy-tab .tab-subtitle {
    font-size: 11px;
    font-weight: 400;
    color: var(--colorNeutralForeground3);
    display: block;
    margin-top: 2px;
  }
  
  .strategy-tab.active .tab-subtitle {
    color: var(--colorBrandPrimary);
    opacity: 0.7;
  }

  /* å¼¹æ€§é€€ä¼‘å¹´é¾„é€‰æ‹©æŒ‰é’® */
  .claim-age-btn {
    flex: 1;
    padding: 12px 16px;
    font-size: 14px;
    border: 2px solid var(--colorNeutralStroke1);
    border-radius: var(--borderRadius);
    background: var(--colorNeutralBackground2);
    color: var(--colorNeutralForeground2);
    cursor: pointer;
    transition: all 0.25s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }
  
  .claim-age-btn:hover {
    border-color: var(--colorBrandPrimary);
    background: var(--colorBrandSubtle);
    transform: translateY(-2px);
    box-shadow: var(--shadow8);
  }
  
  .claim-age-btn.active {
    border-color: var(--colorBrandPrimary);
    background: var(--colorBrandPrimary);
    color: white;
    box-shadow: 0 4px 12px rgba(74, 95, 219, 0.3);
    transform: translateY(-2px);
  }
  
  .claim-age-btn .legal-tag,
  .claim-age-btn .early-tag,
  .claim-age-btn .delay-tag {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 500;
  }
  
  .claim-age-btn .legal-tag {
    background: var(--colorBrandSubtle);
    color: var(--colorBrandPrimary);
  }
  
  .claim-age-btn .early-tag {
    background: #fef3c7;
    color: #92400e;
  }
  
  .claim-age-btn .delay-tag {
    background: #dbeafe;
    color: #1e40af;
  }
  
  .claim-age-btn.active .legal-tag,
  .claim-age-btn.active .early-tag,
  .claim-age-btn.active .delay-tag {
    background: rgba(255,255,255,0.2);
    color: white;
  }

  /* æ—¶é—´çº¿æ ·å¼ - ä¸Šä¸‹åˆ†è¡Œ */
  .timeline-wrapper {
    margin: 0 0 8px;
  }
  
  /* å¹´ä»½è¡Œï¼ˆè¿›åº¦æ¡ä¸Šæ–¹ï¼‰ */
  .timeline-years {
    display: flex;
    justify-content: space-between;
    position: relative;
    margin-bottom: 6px;
    font-size: 12px;
    font-weight: 600;
    color: var(--colorNeutralForeground1);
  }
  
  .timeline-years .year-mid {
    position: absolute;
    transform: translateX(-50%);
  }
  
  /* è¿›åº¦æ¡ */
  .timeline-track {
    position: relative;
    height: 8px;
    margin: 0;
  }
  
  .timeline-progress {
    display: flex;
    height: 8px;
    border-radius: 4px;
    overflow: hidden;
    background: #e5e7eb;
  }
  
  .timeline-seg {
    height: 100%;
  }
  
  .timeline-seg.work { background: #22c55e; }
  .timeline-seg.selfpay { background: #f59e0b; }
  .timeline-seg.waiting { background: #e5e7eb; }
  
  /* æ—¶é—´çº¿èŠ‚ç‚¹ï¼ˆåœ†ç‚¹ï¼‰ */
  .timeline-point {
    position: absolute;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: white;
    border: 2.5px solid;
    box-shadow: 0 1px 2px rgba(0,0,0,0.12);
  }
  
  .timeline-point.start { left: 0; transform: translateY(-50%); }
  .timeline-point.end { right: 0; left: auto; transform: translateY(-50%); }
  
  .timeline-point.now { border-color: #22c55e; }
  .timeline-point.quit { border-color: #f59e0b; }
  .timeline-point.stop { border-color: #9ca3af; }
  .timeline-point.retire { border-color: #3b82f6; }
  
  /* å¹´é¾„/äº‹ä»¶è¡Œï¼ˆè¿›åº¦æ¡ä¸‹æ–¹ï¼‰ */
  .timeline-events {
    display: flex;
    justify-content: space-between;
    position: relative;
    margin-top: 6px;
    font-size: 11px;
    color: var(--colorNeutralForeground2);
    height: 16px;
  }
  
  .timeline-events .event-mid {
    position: absolute;
    transform: translateX(-50%);
    white-space: nowrap;
  }
  
  /* å½“ä½ç½®å¤ªè¿‘æ—¶éšè—ä¸­é—´æ ‡ç­¾ */
  .timeline-events .event-mid.hidden {
    display: none;
  }
  
  .timeline-legend {
    display: flex;
    gap: 16px;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 12px;
  }
  
  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--colorNeutralForeground2);
  }
  
  .legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 2px;
  }
  
  .legend-dot.work { background: #22c55e; }
  .legend-dot.selfpay { background: #f59e0b; }
  .legend-dot.waiting { background: #e5e7eb; }
</style>
</head>
<body>

<div class="container">

  <!-- é¦–é¡µ Hero -->
  <div id="home" class="card hero-card">
    <div class="hero-icon">â°</div>
    <h1>ä½ ç¦»è‡ªç”±è¿˜æœ‰å¤šè¿œï¼Ÿ</h1>
    <p class="subtitle">åŒ—äº¬æå‰é€€ä¼‘è§„åˆ’æ¨¡æ‹Ÿå™¨</p>
    <p class="hero-desc">3åˆ†é’Ÿç®—æ¸…è¾èŒæˆæœ¬ï¼Œçœ‹çœ‹ä½ èƒ½å¦æå‰å®ç°è´¢åŠ¡è‡ªç”±ã€‚</p>
    <div style="margin-top: 28px;">
      <button onclick="showForm()" class="primary-btn">å¼€å§‹æµ‹ç®—</button>
    </div>
    <div class="hero-features">
      <span class="feature-tag">âœ“ 2024æ–°æ”¿ç­–</span>
      <span class="feature-tag">âœ“ å¼¹æ€§é€€ä¼‘</span>
      <span class="feature-tag">âœ“ åŒ»ä¿æµ‹ç®—</span>
    </div>
  </div>

  <!-- è¾“å…¥é¡µ -->
  <div id="form" class="card hidden">
    <!-- è¿›åº¦æ¡ -->
    <div class="progress-steps">
      <div class="step">
        <div class="step-indicator active" id="step1-indicator">1</div>
        <span class="step-label active" id="step1-label">åŸºæœ¬ä¿¡æ¯</span>
      </div>
      <div class="step-connector" id="connector1"></div>
      <div class="step">
        <div class="step-indicator" id="step2-indicator">2</div>
        <span class="step-label" id="step2-label">ç¤¾ä¿æƒ…å†µ</span>
      </div>
      <div class="step-connector" id="connector2"></div>
      <div class="step">
        <div class="step-indicator" id="step3-indicator">3</div>
        <span class="step-label" id="step3-label">é€€ä¼‘è®¡åˆ’</span>
      </div>
    </div>

    <!-- æ­¥éª¤1ï¼šåŸºæœ¬ä¿¡æ¯ -->
    <div id="step1" class="form-step">
      <h2>åŸºæœ¬ä¿¡æ¯</h2>

      <div class="form-field">
        <label>å‡ºç”Ÿå¹´æœˆ</label>
        <div class="date-picker-row">
          <fluent-select id="birthYear" style="flex:1">
            <!-- å¹´ä»½é€‰é¡¹ç”±JSåŠ¨æ€ç”Ÿæˆ -->
          </fluent-select>
          <fluent-select id="birthMonth" style="flex:1">
            <fluent-option value="1">1æœˆ</fluent-option>
            <fluent-option value="2">2æœˆ</fluent-option>
            <fluent-option value="3">3æœˆ</fluent-option>
            <fluent-option value="4">4æœˆ</fluent-option>
            <fluent-option value="5">5æœˆ</fluent-option>
            <fluent-option value="6">6æœˆ</fluent-option>
            <fluent-option value="7">7æœˆ</fluent-option>
            <fluent-option value="8">8æœˆ</fluent-option>
            <fluent-option value="9">9æœˆ</fluent-option>
            <fluent-option value="10">10æœˆ</fluent-option>
            <fluent-option value="11">11æœˆ</fluent-option>
            <fluent-option value="12">12æœˆ</fluent-option>
          </fluent-select>
        </div>
      </div>

      <div class="form-field">
        <label>æ€§åˆ«</label>
        <fluent-select id="gender">
          <fluent-option value="female">å¥³</fluent-option>
          <fluent-option value="male">ç”·</fluent-option>
        </fluent-select>
      </div>

      <div class="form-field">
        <label>æ˜¯å¦åŒ—äº¬æˆ·ç±</label>
        <fluent-select id="hukou">
          <fluent-option value="no">å¦</fluent-option>
          <fluent-option value="yes">æ˜¯</fluent-option>
        </fluent-select>
      </div>

      <div class="btn-group">
        <button class="secondary-btn" onclick="showHome()">è¿”å›</button>
        <button class="primary-btn" onclick="nextStep(1)">ä¸‹ä¸€æ­¥</button>
      </div>
    </div>

    <!-- æ­¥éª¤2ï¼šç¤¾ä¿æƒ…å†µ -->
    <div id="step2" class="form-step hidden">
      <h2>å½“å‰ç¤¾ä¿æƒ…å†µ</h2>

      <div class="form-field">
        <label>å·²ç´¯è®¡ç¼´è´¹å¹´é™ï¼ˆå¹´ï¼‰</label>
        <fluent-text-field type="number" id="years"></fluent-text-field>
      </div>

      <div class="form-field">
        <label>ä¸ªäººè´¦æˆ·ä½™é¢ï¼ˆå…ƒï¼‰</label>
        <fluent-text-field type="number" id="balance"></fluent-text-field>
        <p class="hint">æŸ¥è¯¢æ–¹å¼ï¼šäº¬é€šå°ç¨‹åº â†’ ç¤¾ä¿ä¸ªäººå¯¹è´¦å• â†’ é€‰æ‹©ä¸Šä¸€ä¸ªå¹´ä»½</p>
      </div>

      <div class="btn-group">
        <button class="secondary-btn" onclick="prevStep(2)">ä¸Šä¸€æ­¥</button>
        <button class="primary-btn" onclick="nextStep(2)">ä¸‹ä¸€æ­¥</button>
      </div>
    </div>

    <!-- æ­¥éª¤3ï¼šé€€ä¼‘è®¡åˆ’ -->
    <div id="step3" class="form-step hidden">
      <h2>ä½ çš„é€€ä¼‘è®¡åˆ’</h2>

      <div class="form-field">
        <label>è®¡åˆ’è¾èŒå¹´é¾„ï¼ˆå²ï¼‰</label>
        <fluent-text-field type="number" id="quitAge" placeholder="ä¾‹å¦‚ 45"></fluent-text-field>
        <p class="hint">
          è¾èŒåç¤¾ä¿è´¹ç”¨æŒ‰åŒ—äº¬æœ€ä½åŸºæ•°ä¼°ç®—ï¼š<br/>
          â€¢ åŒ—äº¬æˆ·ç±ï¼šçµæ´»å°±ä¸š â‰ˆ Â¥1,800/æœˆ<br/>
          â€¢ éåŒ—äº¬æˆ·ç±ï¼šå…¬å¸ä»£ç¼´ â‰ˆ Â¥2,800/æœˆ
        </p>
      </div>

      <div class="btn-group">
        <button class="secondary-btn" onclick="prevStep(3)">ä¸Šä¸€æ­¥</button>
        <button class="primary-btn" onclick="calculate()">æŸ¥çœ‹ç»“æœ</button>
      </div>
    </div>
  </div>

  <!-- ç»“æœé¡µ -->
  <div id="result" class="hidden"></div>

</div>

<script>
// åˆå§‹åŒ–å¹´ä»½é€‰é¡¹
document.addEventListener('DOMContentLoaded', () => {
  const yearSelect = document.getElementById('birthYear');
  // ç›®æ ‡ç”¨æˆ·æ˜¯åœ¨èŒäººå‘˜ï¼Œå¹´é¾„çº¦25-60å²ï¼Œé™åˆ¶å¹´ä»½èŒƒå›´
  const currentYear = new Date().getFullYear();
  const startYear = currentYear - 60; // æœ€å¤§60å²
  const endYear = currentYear - 25;   // æœ€å°25å²
  for (let y = endYear; y >= startYear; y--) {
    const option = document.createElement('fluent-option');
    option.value = y;
    option.textContent = y + 'å¹´';
    yearSelect.appendChild(option);
  }
});

function showForm() {
  document.getElementById('home').classList.add('hidden');
  document.getElementById('form').classList.remove('hidden');
  goToStep(1);
}

function showHome() {
  document.getElementById('form').classList.add('hidden');
  document.getElementById('result').classList.add('hidden');
  document.getElementById('home').classList.remove('hidden');
}

let currentStep = 1;

function goToStep(step) {
  document.querySelectorAll('.form-step').forEach(el => el.classList.add('hidden'));
  document.getElementById('step' + step).classList.remove('hidden');
  
  for (let i = 1; i <= 3; i++) {
    const indicator = document.getElementById('step' + i + '-indicator');
    const label = document.getElementById('step' + i + '-label');
    const connector = document.getElementById('connector' + i);
    
    indicator.classList.remove('active', 'done');
    label.classList.remove('active');
    if (connector) connector.classList.remove('done');
    
    if (i < step) {
      indicator.classList.add('done');
      indicator.innerHTML = 'âœ“';
      if (connector) connector.classList.add('done');
    } else if (i === step) {
      indicator.classList.add('active');
      label.classList.add('active');
      indicator.innerHTML = i;
    } else {
      indicator.innerHTML = i;
    }
  }
  
  currentStep = step;
}

function validateStep(step) {
  let valid = true;
  let firstInvalid = null;
  
  const markInvalid = (el) => {
    el.classList.add('field-invalid');
    if (!firstInvalid) firstInvalid = el;
  };
  
  const markValid = (el) => {
    el.classList.remove('field-invalid');
  };
  
  if (step === 1) {
    const birthYear = document.getElementById('birthYear');
    const birthMonth = document.getElementById('birthMonth');
    const gender = document.getElementById('gender');
    const hukou = document.getElementById('hukou');
    
    [birthYear, birthMonth, gender, hukou].forEach(el => {
      if (!el.value) {
        markInvalid(el);
        valid = false;
      } else {
        markValid(el);
      }
    });
  } else if (step === 2) {
    const years = document.getElementById('years');
    const balance = document.getElementById('balance');
    
    const yearsVal = years.value || years.control?.value;
    const balanceVal = balance.value || balance.control?.value;
    
    if (!yearsVal || parseFloat(yearsVal) <= 0) {
      markInvalid(years);
      valid = false;
    } else {
      markValid(years);
    }
    
    if (!balanceVal || parseFloat(balanceVal) <= 0) {
      markInvalid(balance);
      valid = false;
    } else {
      markValid(balance);
    }
  } else if (step === 3) {
    const quitAge = document.getElementById('quitAge');
    const quitAgeVal = quitAge.value || quitAge.control?.value;
    
    if (!quitAgeVal || parseFloat(quitAgeVal) <= 0) {
      markInvalid(quitAge);
      valid = false;
    } else {
      markValid(quitAge);
    }
  }
  
  if (firstInvalid) {
    firstInvalid.focus();
  }
  
  return valid;
}

function nextStep(from) {
  if (!validateStep(from)) return;
  if (from < 3) goToStep(from + 1);
}

function prevStep(from) {
  if (from > 1) goToStep(from - 1);
}

function ageFromBirth(year, month) {
  const now = new Date();
  let age = now.getFullYear() - year;
  if (now.getMonth() + 1 < month) age--;
  return age;
}

function legalRetirementAge(gender, birthYear) {
  // æ–°æ³•å®šé€€ä¼‘å¹´é¾„ï¼ˆæ¸è¿›å¼å»¶è¿Ÿåï¼‰
  if (gender === 'female') {
    let r = 50 + (birthYear - 1975) * 0.2;
    return Math.min(Math.max(r, 50), 55);
  } else {
    let r = 60 + (birthYear - 1965) * 0.15;
    return Math.min(Math.max(r, 60), 63);
  }
}

// åŸæ³•å®šé€€ä¼‘å¹´é¾„ï¼ˆæ”¹é©å‰ï¼‰
function originalRetirementAge(gender) {
  return gender === 'female' ? 50 : 60;
}

// è®¡ç®—å¼¹æ€§é€€ä¼‘èŒƒå›´
// å¯æå‰æœ€å¤š3å¹´ï¼Œä½†ä¸èƒ½æ—©äºåŸæ³•å®šå¹´é¾„
// å¯æ¨è¿Ÿæœ€å¤š3å¹´ï¼Œä¸”ä¸è¶…è¿‡65å²
function flexibleRetirementRange(gender, birthYear) {
  const legalAge = legalRetirementAge(gender, birthYear);
  const originalAge = originalRetirementAge(gender);
  
  // æœ€æ—©é¢†å–å¹´é¾„ï¼šæ³•å®šå¹´é¾„-3å¹´ï¼Œä½†ä¸æ—©äºåŸæ³•å®šå¹´é¾„
  const earliest = Math.max(legalAge - 3, originalAge);
  // æœ€æ™šé¢†å–å¹´é¾„ï¼šæ³•å®šå¹´é¾„+3å¹´ï¼Œä¸”ä¸è¶…è¿‡65å²
  const latest = Math.min(legalAge + 3, 65);
  
  return { legalAge, originalAge, earliest, latest };
}

function divisor(age) {
  // ä¸ªäººè´¦æˆ·å…»è€é‡‘è®¡å‘æœˆæ•°è¡¨ï¼ˆå®˜æ–¹æ ‡å‡†ï¼‰
  const table = {
    40: 233, 41: 230, 42: 226, 43: 223, 44: 220,
    45: 216, 46: 212, 47: 208, 48: 204, 49: 199,
    50: 195, 51: 190, 52: 185, 53: 180, 54: 175,
    55: 170, 56: 164, 57: 158, 58: 152, 59: 145,
    60: 139, 61: 132, 62: 125, 63: 117, 64: 109,
    65: 101, 66: 93, 67: 84, 68: 75, 69: 65, 70: 56
  };
  const intAge = Math.floor(age);
  const clamped = Math.max(40, Math.min(70, intAge));
  return table[clamped] || 139;
}

function purchasingPower(amount, years, inflation = 0.03) {
  return amount / Math.pow(1 + inflation, years);
}

// å…»è€ä¿é™©æœ€ä½ç¼´è´¹å¹´é™ï¼šå›ºå®š20å¹´
function minPensionYears(retireYear) {
  return 20;
}

// ä¿å­˜ç”¨æˆ·åŸºç¡€æ•°æ®ï¼Œç”¨äºé‡æ–°è®¡ç®—
let userData = {};
let currentStrategy = 'full'; // 'full' = ç¼´åˆ°é€€ä¼‘, 'min' = ç¼´æ»¡æœ€ä½å¹´é™å³åœ
let currentClaimAge = null; // å®é™…é¢†å–å¹´é¾„ï¼ˆå¼¹æ€§é€€ä¼‘ï¼‰

// æ ¸å¿ƒè®¡ç®—å‡½æ•°
// stopAtMinYears: true=ç¼´æ»¡æœ€ä½å¹´é™å³åœï¼Œfalse=ç¼´åˆ°é€€ä¼‘
// claimAge: å®é™…é¢†å–å…»è€é‡‘çš„å¹´é¾„ï¼ˆå¼¹æ€§é€€ä¼‘ï¼‰
function computeRetirement(quitAge, stopAtMinYears = false, claimAge = null) {
  const { birthYear, birthMonth, gender, hukou, yearsPaidNow, balanceNow } = userData;
  
  const minBase = 6326;
  const flexMonthly = (hukou === 'yes') ? 1800 : 2800;
  const payMethod = (hukou === 'yes') ? 'çµæ´»å°±ä¸š' : 'å…¬å¸ä»£ç¼´';
  const monthlyToAccount = minBase * 0.08;

  const ageNow = ageFromBirth(birthYear, birthMonth);
  const flexRange = flexibleRetirementRange(gender, birthYear);
  const legalAge = flexRange.legalAge;
  
  // å®é™…é¢†å–å¹´é¾„ï¼šå¦‚æœæœªæŒ‡å®šï¼Œä½¿ç”¨æ³•å®šå¹´é¾„
  const actualClaimAge = claimAge !== null ? claimAge : legalAge;
  
  // è®¡ç®—é€€ä¼‘å¹´ä»½ï¼ˆç”¨äºç¡®å®šæœ€ä½ç¼´è´¹å¹´é™ï¼‰
  const retireYear = birthYear + Math.ceil(actualClaimAge);
  // æ ¹æ®é€€ä¼‘å¹´ä»½ç¡®å®šå…»è€ä¿é™©æœ€ä½ç¼´è´¹å¹´é™
  const minPensionYearsRequired = minPensionYears(retireYear);

  const yearsWorking = Math.max(quitAge - ageNow, 0);
  const avgYearlyToAccount = balanceNow / yearsPaidNow;
  const yearsAtQuit = yearsPaidNow + yearsWorking;
  const balanceAtQuit = balanceNow + avgYearlyToAccount * yearsWorking;

  // è®¡ç®—è‡ªè´¹ç¼´çº³å¹´é™ï¼ˆç¼´åˆ°å®é™…é¢†å–å¹´é¾„ï¼‰
  let yearsFlexPay;
  let stopPayAge = null; // åœæ­¢ç¼´è´¹çš„å¹´é¾„ï¼ˆä»…å½“ç¼´æ»¡å³åœç­–ç•¥æœ‰æ•ˆï¼‰
  let yearsWaiting = 0; // åœæ­¢ç¼´è´¹åˆ°é€€ä¼‘çš„ç­‰å¾…å¹´æ•°
  
  if (stopAtMinYears) {
    // ç­–ç•¥ï¼šç¼´æ»¡æœ€ä½å¹´é™å³åœ
    const yearsNeededForMin = Math.max(minPensionYearsRequired - yearsAtQuit, 0);
    yearsFlexPay = Math.min(yearsNeededForMin, actualClaimAge - quitAge);
    stopPayAge = quitAge + yearsFlexPay;
    yearsWaiting = Math.max(actualClaimAge - stopPayAge, 0);
  } else {
    // ç­–ç•¥ï¼šç¼´åˆ°é¢†å–å¹´é¾„
    yearsFlexPay = Math.max(actualClaimAge - quitAge, 0);
  }
  
  const yearlyToAccountFlex = monthlyToAccount * 12;
  const pensionFlexCost = flexMonthly * 12 * yearsFlexPay; // å…»è€+åŒ»ä¿ç»¼åˆè´¹ç”¨
  const totalYears = yearsAtQuit + yearsFlexPay;
  const finalBalance = balanceAtQuit + yearlyToAccountFlex * yearsFlexPay;

  // å…»è€é‡‘è®¡ç®—ä½¿ç”¨å®é™…é¢†å–å¹´é¾„
  const personalPension = finalBalance / divisor(actualClaimAge);
  const avgWage = 14000;
  const basePension = avgWage * totalYears * 0.01 * 0.9;
  const monthlyPension = personalPension + basePension;

  // å…»è€ä¿é™©æ˜¯å¦æ»¡è¶³æœ€ä½å¹´é™
  const pensionOK = totalYears >= minPensionYearsRequired;
  const pensionShortfall = pensionOK ? 0 : minPensionYearsRequired - totalYears;

  // åŒ»ä¿ï¼ˆåŒ—äº¬ï¼šå¥³20å¹´ï¼Œç”·25å¹´ï¼‰
  const needMedicalYears = (gender === 'female') ? 20 : 25;
  const medicalOK = totalYears >= needMedicalYears;
  const medicalShortfall = medicalOK ? 0 : needMedicalYears - totalYears;
  
  // åŒ»ä¿è¡¥ç¼´è´¹ç”¨ï¼ˆå¦‚æœå¹´é™ä¸è¶³ï¼Œéœ€è¦åœ¨é€€ä¼‘åè¡¥ç¼´ï¼‰
  // åŒ—äº¬çµæ´»å°±ä¸šåŒ»ä¿çº¦500å…ƒ/æœˆï¼Œä¸€æ¬¡æ€§è¡¥ç¼´æŒ‰æ­¤ä¼°ç®—
  const medicalMonthly = 500;
  const medicalExtraCost = medicalOK ? 0 : medicalShortfall * 12 * medicalMonthly;
  
  // æ€»æˆæœ¬ = è¾èŒåç¼´è´¹ + åŒ»ä¿è¡¥ç¼´
  const totalFlexCost = pensionFlexCost + medicalExtraCost;

  const paybackYears = totalFlexCost > 0 ? totalFlexCost / (monthlyPension * 12) : 0;

  const yearsFromNow = actualClaimAge - ageNow;
  const realPension = purchasingPower(monthlyPension, yearsFromNow);

  const lifeExpectancy = 80;
  const yearsReceiving = lifeExpectancy - actualClaimAge;
  const totalReceived = monthlyPension * 12 * yearsReceiving;
  const netGain = totalReceived - totalFlexCost;

  return {
    ageNow, legalAge, quitAge, gender, hukou, payMethod, flexMonthly,
    yearsWorking, yearsFlexPay, pensionFlexCost, totalFlexCost, totalYears, finalBalance,
    monthlyPension, realPension, paybackYears, 
    pensionOK, pensionShortfall, minPensionYearsRequired, retireYear,
    medicalOK, medicalShortfall, needMedicalYears, medicalExtraCost, medicalMonthly,
    totalReceived, netGain, avgYearlyToAccount, yearlyToAccountFlex, balanceNow,
    stopAtMinYears, stopPayAge, yearsWaiting,
    actualClaimAge, flexRange
  };
}

function calculate() {
  if (!validateStep(3)) return;
  
  const birthYearEl = document.getElementById('birthYear');
  const birthMonthEl = document.getElementById('birthMonth');
  const genderEl = document.getElementById('gender');
  const hukouEl = document.getElementById('hukou');
  
  const birthYear = parseInt(birthYearEl.value) || 1980;
  const birthMonth = parseInt(birthMonthEl.value) || 1;
  const gender = genderEl.value || 'female';
  const hukou = hukouEl.value || 'no';
  
  const yearsEl = document.getElementById('years');
  const balanceEl = document.getElementById('balance');
  const quitAgeEl = document.getElementById('quitAge');
  
  const yearsPaidNow = parseFloat(yearsEl.value || yearsEl.control?.value || 0);
  const balanceNow = parseFloat(balanceEl.value || balanceEl.control?.value || 0);
  const quitAge = parseFloat(quitAgeEl.value || quitAgeEl.control?.value || 0);

  // ä¿å­˜ç”¨æˆ·æ•°æ®
  userData = { birthYear, birthMonth, gender, hukou, yearsPaidNow, balanceNow };

  showResult(quitAge);
}

function showResult(quitAge, strategy = currentStrategy, claimAge = currentClaimAge) {
  currentStrategy = strategy;
  const stopAtMinYears = strategy === 'min';
  
  // å…ˆè®¡ç®—ä¸€æ¬¡è·å–å¼¹æ€§é€€ä¼‘èŒƒå›´
  const tempR = computeRetirement(quitAge, stopAtMinYears, null);
  const flexRange = tempR.flexRange;
  
  // å¦‚æœ claimAge ä¸º nullï¼Œä½¿ç”¨æ³•å®šå¹´é¾„
  if (claimAge === null) {
    claimAge = flexRange.legalAge;
  }
  currentClaimAge = claimAge;
  
  const r = computeRetirement(quitAge, stopAtMinYears, claimAge);
  const { ageNow, legalAge, gender, hukou, payMethod, flexMonthly,
    yearsWorking, yearsFlexPay, totalFlexCost, totalYears, finalBalance,
    monthlyPension, realPension, paybackYears, 
    pensionOK, pensionShortfall, minPensionYearsRequired, retireYear,
    medicalOK, medicalShortfall, needMedicalYears, 
    totalReceived, netGain, avgYearlyToAccount, yearlyToAccountFlex, balanceNow, actualClaimAge } = r;

  // è®¡ç®—æ—¶é—´çº¿å…³é”®èŠ‚ç‚¹
  const nowYear = new Date().getFullYear();
  const quitYear = nowYear + Math.round(quitAge - ageNow);
  const age80Year = userData.birthYear + 80;
  const stopPayYear = r.stopPayAge ? nowYear + Math.round(r.stopPayAge - ageNow) : null;
  const claimYear = userData.birthYear + Math.ceil(actualClaimAge);

  document.getElementById('form').classList.add('hidden');
  document.getElementById('result').classList.remove('hidden');

  // ç”Ÿæˆå¼¹æ€§é€€ä¼‘å¹´é¾„é€‰é¡¹
  const claimAgeOptions = [
    { age: flexRange.earliest, type: 'early' },
    { age: flexRange.legalAge, type: 'legal' },
    { age: flexRange.latest, type: 'delay' },
  ].map(opt => ({
    ...opt,
    isCurrent: Math.abs(opt.age - actualClaimAge) < 0.1
  }));

  document.getElementById('result').innerHTML = `
    <div class="stat-card">
      <h2>ä½ çš„æå‰é€€ä¼‘åˆ†æ</h2>
      <p>å½“å‰ <strong>${ageNow} å²</strong>ï¼Œè®¡åˆ’ <strong>${quitAge} å²</strong> è¾èŒï¼Œæ³•å®šé€€ä¼‘å¹´é¾„ <strong>${legalAge.toFixed(1)} å²</strong></p>
      <p class="hint">${hukou === 'yes' ? 'åŒ—äº¬æˆ·ç±ï¼šè¾èŒåæŒ‰çµæ´»å°±ä¸šç¼´çº³' : 'éåŒ—äº¬æˆ·ç±ï¼šè¾èŒåéœ€å…¬å¸ä»£ç¼´'}ï¼Œæœ€ä½ç¼´è´¹å¹´é™ 20 å¹´</p>
    </div>

    <div class="stat-card">
      <!-- å¼¹æ€§é€€ä¼‘é€‰æ‹© -->
      <h3 style="font-size: 14px; color: var(--colorNeutralForeground2); margin: 0 0 12px;">ğŸ¯ é€‰æ‹©é¢†å–å…»è€é‡‘å¹´é¾„</h3>
      <div style="display: flex; gap: 12px; margin-bottom: 16px;">
        ${claimAgeOptions.map(opt => `
          <button class="claim-age-btn ${opt.isCurrent ? 'active' : ''}" 
                  onclick="showResult(${quitAge}, '${strategy}', ${opt.age})">
            <span style="font-size: 16px; font-weight: 600;">${opt.age}å²</span>
            <span class="${opt.type}-tag">${opt.type === 'early' ? 'æå‰3å¹´' : opt.type === 'legal' ? 'æ³•å®š' : 'æ¨è¿Ÿ3å¹´'}</span>
          </button>
        `).join('')}
      </div>
      <p class="hint" style="margin-bottom: 16px;">
        ${actualClaimAge < legalAge 
          ? `æå‰é¢†å–ï¼šå…»è€é‡‘è¾ƒä½ï¼ˆè®¡å‘æœˆæ•°${divisor(actualClaimAge)}ä¸ªæœˆï¼‰ï¼Œä½†æ›´æ—©äº«å—` 
          : actualClaimAge > legalAge 
            ? `æ¨è¿Ÿé¢†å–ï¼šå…»è€é‡‘æ›´é«˜ï¼ˆè®¡å‘æœˆæ•°${divisor(actualClaimAge)}ä¸ªæœˆï¼‰ï¼Œç¼´è´¹æ—¶é—´æ›´é•¿`
            : `æŒ‰æ³•å®šå¹´é¾„é¢†å–ï¼ˆè®¡å‘æœˆæ•°${divisor(actualClaimAge)}ä¸ªæœˆï¼‰`}
      </p>

      <!-- Tab åˆ‡æ¢ï¼šç¼´è´¹ç­–ç•¥ -->
      <div class="strategy-tabs">
        <button class="strategy-tab ${strategy === 'full' ? 'active' : ''}" onclick="showResult(${quitAge}, 'full', ${actualClaimAge})">
          ç¼´åˆ°é¢†å–
          <span class="tab-subtitle">å…»è€é‡‘æ›´é«˜</span>
        </button>
        <button class="strategy-tab ${strategy === 'min' ? 'active' : ''}" onclick="showResult(${quitAge}, 'min', ${actualClaimAge})">
          ç¼´æ»¡20å¹´å³åœ
          <span class="tab-subtitle">çœé’±ä½†å…»è€é‡‘è¾ƒä½</span>
        </button>
      </div>

      <!-- æ—¶é—´çº¿ -->
      <h3 style="font-size: 14px; color: var(--colorNeutralForeground2); margin: 0 0 12px;">äººç”Ÿæ—¶é—´çº¿</h3>
      <div class="timeline-wrapper">
        <!-- å¹´ä»½è¡Œ -->
        <div class="timeline-years">
          <span>${nowYear}</span>
          ${yearsWorking > 0.1 && (yearsWorking / (yearsWorking + yearsFlexPay + r.yearsWaiting)) >= 0.2 ? `<span class="year-mid" style="left: ${(yearsWorking / (yearsWorking + yearsFlexPay + r.yearsWaiting)) * 100}%;">${quitYear}</span>` : ''}
          ${r.yearsWaiting > 0.1 && ((yearsWorking + yearsFlexPay) / (yearsWorking + yearsFlexPay + r.yearsWaiting)) <= 0.8 ? `<span class="year-mid" style="left: ${((yearsWorking + yearsFlexPay) / (yearsWorking + yearsFlexPay + r.yearsWaiting)) * 100}%;">${stopPayYear}</span>` : ''}
          <span>${claimYear}</span>
        </div>
        
        <!-- è¿›åº¦æ¡ -->
        <div class="timeline-track">
          <div class="timeline-progress">
            ${yearsWorking > 0.1 ? `<div class="timeline-seg work" style="flex: ${yearsWorking};"></div>` : ''}
            ${yearsFlexPay > 0.1 ? `<div class="timeline-seg selfpay" style="flex: ${yearsFlexPay};"></div>` : ''}
            ${r.yearsWaiting > 0.1 ? `<div class="timeline-seg waiting" style="flex: ${r.yearsWaiting};"></div>` : ''}
          </div>
          <div class="timeline-point start ${yearsWorking > 0.1 ? 'now' : 'quit'}"></div>
          ${yearsWorking > 0.1 ? `<div class="timeline-point quit" style="left: ${(yearsWorking / (yearsWorking + yearsFlexPay + r.yearsWaiting)) * 100}%;"></div>` : ''}
          ${r.yearsWaiting > 0.1 ? `<div class="timeline-point stop" style="left: ${((yearsWorking + yearsFlexPay) / (yearsWorking + yearsFlexPay + r.yearsWaiting)) * 100}%;"></div>` : ''}
          <div class="timeline-point end retire"></div>
        </div>
        
        <!-- å¹´é¾„/äº‹ä»¶è¡Œ -->
        <div class="timeline-events">
          <span>${Math.round(ageNow)}å²Â·ç°åœ¨</span>
          ${yearsWorking > 0.1 && (yearsWorking / (yearsWorking + yearsFlexPay + r.yearsWaiting)) >= 0.2 ? `<span class="event-mid" style="left: ${(yearsWorking / (yearsWorking + yearsFlexPay + r.yearsWaiting)) * 100}%;">${quitAge}å²Â·è¾èŒ</span>` : ''}
          ${r.yearsWaiting > 0.1 && ((yearsWorking + yearsFlexPay) / (yearsWorking + yearsFlexPay + r.yearsWaiting)) <= 0.8 ? `<span class="event-mid" style="left: ${((yearsWorking + yearsFlexPay) / (yearsWorking + yearsFlexPay + r.yearsWaiting)) * 100}%;">${Math.round(r.stopPayAge)}å²Â·åœç¼´</span>` : ''}
          <span>${actualClaimAge}å²Â·é¢†å–</span>
        </div>
        
        <!-- å›¾ä¾‹ -->
        <div class="timeline-legend">
          ${yearsWorking > 0.1 ? `<span class="legend-item"><span class="legend-dot work"></span>åœ¨èŒ ${yearsWorking.toFixed(1)}å¹´</span>` : ''}
          ${yearsFlexPay > 0.1 ? `<span class="legend-item"><span class="legend-dot selfpay"></span>${payMethod} ${yearsFlexPay.toFixed(1)}å¹´</span>` : ''}
          ${r.yearsWaiting > 0.1 ? `<span class="legend-item"><span class="legend-dot waiting"></span>ç­‰å¾… ${r.yearsWaiting.toFixed(1)}å¹´</span>` : ''}
        </div>
      </div>

      <!-- æ ¸å¿ƒæ•°æ®ï¼šæˆæœ¬ä¸æ”¶ç›Š -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 24px;">
        <div>
          <h3 style="font-size: 14px; color: var(--colorNeutralForeground2); margin: 0 0 8px;">ğŸ’° è¾èŒåæ€»æˆæœ¬</h3>
          <div class="stat-value negative" style="font-size: 28px;">Â¥${(totalFlexCost/10000).toFixed(1)} ä¸‡</div>
          <p style="font-size: 12px; color: var(--colorNeutralForeground3); margin: 4px 0 0;">
            ç¤¾ä¿ Â¥${(r.pensionFlexCost/10000).toFixed(1)}ä¸‡${r.medicalExtraCost > 0 ? ` + åŒ»ä¿è¡¥ç¼´ Â¥${(r.medicalExtraCost/10000).toFixed(1)}ä¸‡` : ''}
          </p>
        </div>
        <div>
          <h3 style="font-size: 14px; color: var(--colorNeutralForeground2); margin: 0 0 8px;">ğŸ“ˆ æœˆå…»è€é‡‘</h3>
          <div class="stat-value positive" style="font-size: 28px;">Â¥${Math.round(monthlyPension)}</div>
          <p style="font-size: 12px; color: var(--colorNeutralForeground3); margin: 4px 0 0;">ç´¯è®¡ ${totalYears.toFixed(1)} å¹´ Â· ä»Šæ—¥è´­ä¹°åŠ› â‰ˆ Â¥${Math.round(realPension)}</p>
        </div>
      </div>
      
      <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--colorNeutralStroke1);">
        <div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 8px;">
          <span style="color: var(--colorNeutralForeground2);">å›æœ¬æ—¶é—´</span>
          <span><strong>${paybackYears.toFixed(1)} å¹´</strong></span>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 8px;">
          <span style="color: var(--colorNeutralForeground2);">æ´»åˆ°80å²å‡€æ”¶ç›Š</span>
          <span style="color: ${netGain > 0 ? 'var(--colorStatusSuccessForeground1)' : 'var(--colorStatusDangerForeground1)'}"><strong>Â¥${(netGain/10000).toFixed(1)} ä¸‡</strong></span>
        </div>
      </div>
    </div>

    <div class="stat-card">
      <h2>ğŸ“‹ å…»è€ä¿é™©ç¼´è´¹å¹´é™</h2>
      ${pensionOK 
        ? '<span class="badge success">æ»¡è¶³æœ€ä½ç¼´è´¹å¹´é™ï¼Œå¯æ­£å¸¸é¢†å–å…»è€é‡‘</span>' 
        : `<span class="badge danger">è¿˜å·® ${pensionShortfall.toFixed(1)} å¹´æ‰èƒ½é¢†å–å…»è€é‡‘</span>`}
      <table class="data-table" style="margin-top: 12px;">
        <tr><th>é¢†å–å…»è€é‡‘å¹´ä»½</th><td>${claimYear} å¹´</td></tr>
        <tr><th>æœ€ä½ç¼´è´¹å¹´é™è¦æ±‚</th><td>20 å¹´</td></tr>
        <tr><th>ä½ çš„ç´¯è®¡ç¼´è´¹å¹´é™</th><td>${totalYears.toFixed(1)} å¹´</td></tr>
      </table>
    </div>

    <div class="stat-card">
      <h2>ğŸ¥ åŒ»ä¿çŠ¶æ€</h2>
      ${medicalOK 
        ? '<span class="badge success">é€€ä¼‘åç»ˆèº«äº«å—åŒ»ä¿</span>' 
        : `<span class="badge danger">è¿˜å·® ${medicalShortfall.toFixed(1)} å¹´ï¼Œéœ€è¡¥ç¼´ Â¥${(r.medicalExtraCost/10000).toFixed(1)} ä¸‡</span>`}
      <table class="data-table" style="margin-top: 12px;">
        <tr><th>${gender === 'female' ? 'å¥³æ€§' : 'ç”·æ€§'}æœ€ä½å¹´é™</th><td>${needMedicalYears} å¹´</td></tr>
        <tr><th>ä½ çš„ç´¯è®¡ç¼´è´¹å¹´é™</th><td>${totalYears.toFixed(1)} å¹´</td></tr>
        ${!medicalOK ? `<tr><th>è¡¥ç¼´è´¹ç”¨</th><td style="color: var(--colorStatusDangerForeground1);">Â¥${(r.medicalExtraCost/10000).toFixed(1)} ä¸‡ï¼ˆ${medicalShortfall.toFixed(1)}å¹´ Ã— Â¥${r.medicalMonthly}/æœˆï¼‰</td></tr>` : ''}
      </table>
    </div>

    <div class="stat-card">
      <h2>ğŸ“‹ æ€»ç»“</h2>
      ${!pensionOK ? `<p style="color: var(--colorStatusDangerForeground1);"><strong>âš ï¸ æ³¨æ„ï¼š</strong>ä½ çš„ç´¯è®¡ç¼´è´¹å¹´é™ä¸è¶³ 20 å¹´ï¼Œ${claimYear}å¹´é¢†å–å…»è€é‡‘æ—¶æ— æ³•æ­£å¸¸é¢†å–ï¼éœ€å»¶é•¿ç¼´è´¹æˆ–ä¸€æ¬¡æ€§è¡¥ç¼´ã€‚</p>` : ''}
      <p><strong>ä½ å°†ä»˜å‡ºï¼š</strong></p>
      <ul class="summary-list">
        <li>ç¤¾ä¿è‡ªç¼´ Â¥${(r.pensionFlexCost/10000).toFixed(1)} ä¸‡ï¼ˆ${yearsFlexPay.toFixed(1)}å¹´ Ã— Â¥${flexMonthly}/æœˆï¼‰</li>
        ${!medicalOK ? `<li>åŒ»ä¿è¡¥ç¼´ Â¥${(r.medicalExtraCost/10000).toFixed(1)} ä¸‡ï¼ˆ${medicalShortfall.toFixed(1)}å¹´ Ã— Â¥${r.medicalMonthly}/æœˆï¼‰</li>` : ''}
        <li><strong>æ€»è®¡ Â¥${(totalFlexCost/10000).toFixed(1)} ä¸‡</strong></li>
        <li>å¦‚æŠ•èµ„ç†è´¢ï¼ˆ4%å¹´åŒ–ï¼‰ï¼Œ${yearsFlexPay.toFixed(0)}å¹´åçº¦ Â¥${(totalFlexCost*Math.pow(1.04,yearsFlexPay)/10000).toFixed(1)} ä¸‡</li>
      </ul>
      <p><strong>ä½ å°†è·å¾—ï¼š</strong></p>
      <ul class="summary-list">
        ${pensionOK ? `<li>æ¯æœˆ Â¥${Math.round(monthlyPension)} å…»è€é‡‘ï¼Œç»ˆèº«å‘æ”¾</li>` : '<li style="color: var(--colorStatusDangerForeground1);">å…»è€é‡‘éœ€æ»¡è¶³æœ€ä½å¹´é™æ‰èƒ½é¢†å–</li>'}
        ${pensionOK ? `<li>${paybackYears.toFixed(1)} å¹´å›æœ¬</li>` : ''}
        ${pensionOK ? `<li>æ´»åˆ°80å²å‡€èµš Â¥${(netGain/10000).toFixed(1)} ä¸‡</li>` : ''}
        <li>${medicalOK ? 'é€€ä¼‘åç»ˆèº«å…è´¹åŒ»ä¿' : 'è¡¥ç¼´åç»ˆèº«å…è´¹åŒ»ä¿'}</li>
      </ul>
    </div>

    <div class="stat-card">
      <h2>ğŸ”„ å°è¯•å…¶ä»–è¾èŒå¹´é¾„</h2>
      <p class="hint">è°ƒæ•´è¾èŒå¹´é¾„ï¼Œæ¯”è¾ƒä¸åŒæ–¹æ¡ˆçš„å·®å¼‚</p>
      <div style="display: flex; gap: 12px; align-items: center; margin: 16px 0;">
        <fluent-text-field type="number" id="newQuitAge" placeholder="${quitAge}" value="${quitAge}" style="flex: 1;"></fluent-text-field>
        <button class="primary-btn" onclick="tryNewAge()" style="padding: 12px 24px;">é‡æ–°è®¡ç®—</button>
      </div>
      
      <h3 style="font-size: 14px; margin: 20px 0 12px; color: var(--colorNeutralForeground2);">å¿«é€Ÿå¯¹æ¯”</h3>
      <div id="comparison-table"></div>
    </div>

    <div style="text-align: center; margin-top: 24px;">
      <button class="secondary-btn" onclick="location.reload()">é‡æ–°å¡«å†™ä¿¡æ¯</button>
    </div>

    <div class="footer">
      æå‰é€€ä¼‘è§„åˆ’æ¨¡æ‹Ÿå™¨ï¼ˆåŒ—äº¬ï¼‰ Â· ä»…ç”¨äºä¼°ç®—ä¸å†³ç­–å‚è€ƒ
    </div>
  `;
  
  // ç”Ÿæˆå¯¹æ¯”è¡¨æ ¼
  generateComparison(quitAge);
}

function tryNewAge() {
  const newAgeEl = document.getElementById('newQuitAge');
  const newAge = parseFloat(newAgeEl.value || newAgeEl.control?.value || 0);
  if (newAge > 0) {
    showResult(newAge, currentStrategy, currentClaimAge);
  }
}

function generateComparison(currentAge) {
  const ageNow = ageFromBirth(userData.birthYear, userData.birthMonth);
  const flexRange = flexibleRetirementRange(userData.gender, userData.birthYear);
  const legalAge = flexRange.legalAge;
  const stopAtMinYears = currentStrategy === 'min';
  
  // ç”Ÿæˆå¯¹æ¯”çš„å¹´é¾„ï¼šå½“å‰å¹´é¾„+2, å½“å‰å¹´é¾„+5, å½“å‰å¹´é¾„+8, æ³•å®šé€€ä¼‘-3
  const claimAge = currentClaimAge || legalAge;
  const ages = [
    Math.max(ageNow + 2, currentAge - 3),
    currentAge,
    Math.min(currentAge + 3, claimAge),
    Math.min(currentAge + 5, claimAge),
  ].filter((v, i, a) => a.indexOf(v) === i && v >= ageNow && v <= claimAge).sort((a, b) => a - b);
  
  let html = '<table class="data-table">';
  html += '<tr><th>è¾èŒå¹´é¾„</th><th>è‡ªè´¹æŠ•å…¥</th><th>æœˆå…»è€é‡‘</th><th>å‡€æ”¶ç›Š(80å²)</th></tr>';
  
  for (const age of ages) {
    const r = computeRetirement(age, stopAtMinYears, claimAge);
    const isCurrent = age === currentAge;
    const rowClass = isCurrent ? 'highlight' : '';
    const gainColor = isCurrent ? '' : (r.netGain > 0 ? 'color: var(--colorStatusSuccessForeground1)' : 'color: var(--colorStatusDangerForeground1)');
    html += `<tr class="${rowClass}">
      <td><strong>${age} å²</strong>${isCurrent ? ' âœ“' : ''}</td>
      <td>Â¥${(r.totalFlexCost/10000).toFixed(1)}ä¸‡</td>
      <td>Â¥${Math.round(r.monthlyPension)}</td>
      <td style="${gainColor}">Â¥${(r.netGain/10000).toFixed(1)}ä¸‡</td>
    </tr>`;
  }
  
  html += '</table>';
  document.getElementById('comparison-table').innerHTML = html;
}
</script>
</body>
</html>
